digraph TimeMoEArchitectureDetailed {
    // Graph properties
    rankdir=TB;
    label="Time-MoE Model Architecture - Detailed View";
    labelloc=top;
    fontsize=18;
    fontname="Arial Bold";
    
    // Node properties
    node [shape=box, style=filled, fillcolor=lightblue, fontname="Arial"];
    
    // Input layer
    input_ts [label="Time Series Input\n[Batch, Seq Len, Features]", fillcolor=lightgreen, shape=box3d];
    
    // Input embedding layer
    input_embed [label="Input Embedding Layer\nMLP with Gate Activation\n(Linear + SiLU activation)", fillcolor=lightseagreen];
    
    // Main transformer blocks
    subgraph cluster_transformer_blocks {
        label="Transformer Blocks (Stacked)";
        color=gray;
        style=dashed;
        fontname="Arial Bold";
        fontsize=14;
        
        // Single transformer block example (since all are similar)
        subgraph cluster_block {
            label="Transformer Block (Repeat N times)";
            color=darkolivegreen;
            style=solid;
            
            // Attention section
            subgraph cluster_attention {
                label="Self-Attention Module";
                color=orange;
                style=filled;
                fillcolor=navajowhite;
                
                ln1 [label="RMSNorm", fillcolor=lightcyan, shape=ellipse];
                att_module [label="Multi-Head Attention\nwith RoPE\n(Q, K, V projections)", fillcolor=orange];
                res1 [label="Residual Connection", fillcolor=lightsalmon, shape=parallelogram];
            }
            
            // Feed-forward section with MoE
            subgraph cluster_ffn {
                label="Feed-Forward Module (MoE)";
                color=purple;
                style=filled;
                fillcolor=thistle;
                
                ln2 [label="RMSNorm", fillcolor=lightcyan, shape=ellipse];
                
                // Router and experts
                router [label="Router/Gating Network\nLinear Layer (H -> Num Experts)", fillcolor=pink];
                
                subgraph cluster_experts {
                    label="Expert Networks";
                    color=gold;
                    style=filled;
                    fillcolor=lemonchiffon;
                    
                    expert1 [label="Expert 1\nTemporal Block\n(Gate, Up, Down Projections)", fillcolor=gold];
                    expert2 [label="Expert 2\nTemporal Block\n(Gate, Up, Down Projections)", fillcolor=gold];
                    expertn [label="Expert N\nTemporal Block\n(Gate, Up, Down Projections)", fillcolor=gold];
                    shared_expert [label="Shared Expert\nTemporal Block\n(Full Intermediate Size)", fillcolor=khaki];
                }
                
                combine [label="Top-K Selection\nand Weighted Combination\n+ Shared Expert Gate", fillcolor=orchid];
                res2 [label="Residual Connection", fillcolor=lightsalmon, shape=parallelogram];
            }
        }
    }
    
    // Output processing
    final_norm [label="Final RMSNorm", fillcolor=lightcyan, shape=ellipse];
    output_proj [label="Output Projection\nMultiple Horizon Heads\n(H -> Horizon Length * Features)", fillcolor=lightgreen, shape=box3d];
    output_pred [label="Predictions\nMultiple Horizons", fillcolor=lightsteelblue, shape=box3d];
    
    // Connections
    input_ts -> input_embed;
    input_embed -> ln1;
    ln1 -> att_module;
    att_module -> res1;
    res1 -> ln2;
    ln2 -> router;
    router -> expert1;
    router -> expert2;
    router -> expertn;
    router -> shared_expert;
    expert1 -> combine;
    expert2 -> combine;
    expertn -> combine;
    shared_expert -> combine;
    combine -> res2;
    res2 -> final_norm;
    final_norm -> output_proj;
    output_proj -> output_pred;
    
    // Annotations
    topk_note [label="Top-K Routing:\nSelects top-k experts\nbased on gate scores", fillcolor=plum, shape=note, pos="0,-6.5!"];
    aux_loss_note [label="Auxiliary Loss:\nLoad balancing term\nfor expert utilization", fillcolor=plum, shape=note, pos="4,-6.5!"];
    
    // Edge styling
    edge [color=black, fontname="Arial"];
}